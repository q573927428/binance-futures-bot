# 移动止损使用说明

## 📖 概述

移动止损功能已成功集成到交易机器人中！当持仓盈利达到一定比例时，自动移动止损价格以保护利润。

---

## ✨ 核心特性

### **自动保护利润**
- 盈利达到激活条件后，止损自动跟随价格向有利方向移动
- 止损只会向保护利润的方向移动，不会回调

### **基于ATR的智能跟踪**
- 使用ATR（真实波动幅度）计算跟踪距离
- 自动适应市场波动率

### **可配置参数**
- 激活盈亏比：何时启动移动止损
- 跟踪距离：止损与当前价格的距离
- 更新间隔：检查频率

---

## ⚙️ 配置说明

### **配置项**

```typescript
trailingStopConfig: {
  enabled: true,                 // 是否启用移动止损
  activationRatio: 0.5,          // 激活盈亏比（0.5 = 盈利达到风险的50%时启用）
  trailingDistance: 1.5,         // 跟踪距离（ATR倍数）
  updateIntervalSeconds: 60,     // 更新间隔秒数
}
```

### **默认值（已配置）**

✅ **已启用** - `enabled: true`
✅ **激活盈亏比 0.5** - 盈利达到初始风险的50%时启动
✅ **跟踪距离 1.5x ATR** - 给予价格波动空间
✅ **60秒更新间隔** - 避免过于频繁的订单操作

---

## 🎯 工作原理

### **1. 激活条件**

假设：
- 入场价：100 USDT
- 初始止损：95 USDT
- 初始风险：5 USDT

**激活点：** 当盈利 ≥ 2.5 USDT（5 × 0.5）时启动

### **2. 移动止损计算**

```
多头：新止损 = MAX(当前止损, 当前价 - ATR × 1.5)
空头：新止损 = MIN(当前止损, 当前价 + ATR × 1.5)
```

### **3. 实例演示（多头）**

| 价格变化 | ATR | 计算新止损 | 实际止损 | 说明 |
|---------|-----|-----------|---------|------|
| 102.5 → 激活 | 3 | 102.5 - 4.5 = 98 | 98 | 首次移动（保本以上） |
| 105 | 3 | 105 - 4.5 = 100.5 | 100.5 | 继续上移 |
| 110 | 3 | 110 - 4.5 = 105.5 | 105.5 | 锁定更多利润 |
| 108 回调 | 3 | 108 - 4.5 = 103.5 | 105.5 | 保持不变（不回调）|

✅ **结果**：即使价格从110回调到108，止损仍保持在105.5，锁定了5.5的利润！

---

## 📊 配置建议

### **保守型（推荐新手）**

```json
{
  "enabled": true,
  "activationRatio": 0.3,        // 盈利30%即启动（更早保护）
  "trailingDistance": 2.0,       // 2倍ATR（更宽松）
  "updateIntervalSeconds": 90    // 90秒更新（较慢）
}
```

✅ 优点：更早进入保本，不易被震出
❌ 缺点：可能过早保护，限制利润空间

---

### **平衡型（当前默认）**

```json
{
  "enabled": true,
  "activationRatio": 0.5,        // 盈利50%启动（平衡）
  "trailingDistance": 1.5,       // 1.5倍ATR（适中）
  "updateIntervalSeconds": 60    // 60秒更新（正常）
}
```

✅ 优点：兼顾利润保护和空间
✅ 适合大多数市场环境

---

### **激进型（适合高波动）**

```json
{
  "enabled": true,
  "activationRatio": 0.8,        // 盈利80%启动（更晚）
  "trailingDistance": 1.0,       // 1倍ATR（更紧）
  "updateIntervalSeconds": 30    // 30秒更新（更快）
}
```

✅ 优点：最大化利润空间
❌ 缺点：风险较高，可能无法保本

---

## 🔧 如何修改配置

### **方法1：编辑配置文件**

修改 `data/bot-config.json`：

```json
{
  "trailingStopConfig": {
    "enabled": true,
    "activationRatio": 0.5,
    "trailingDistance": 1.5,
    "updateIntervalSeconds": 60
  }
}
```

### **方法2：通过API修改**

```bash
curl -X PATCH http://localhost:3000/api/bot/config \
  -H "Content-Type: application/json" \
  -d '{
    "trailingStopConfig": {
      "enabled": true,
      "activationRatio": 0.3
    }
  }'
```

### **方法3：临时禁用**

快速禁用移动止损：

```json
{
  "trailingStopConfig": {
    "enabled": false
  }
}
```

---

## 📈 效果预期

### **无移动止损 vs 有移动止损**

**场景：** BTC多头，入场100，止损95，涨至110后回调至106

| 指标 | 无移动止损 | 有移动止损 |
|------|-----------|-----------|
| 最高浮盈 | +10 USDT | +10 USDT |
| 回调后止损触发点 | 95 | 105.5 |
| 实际盈利 | 继续持仓（可能归零） | +5.5 USDT（锁定）|
| 心理压力 | 高 | 低 |

---

## ⚠️ 注意事项

### **1. 更新成本**
- 每次更新需取消旧止损单 + 创建新止损单
- 建议更新间隔 ≥ 60秒

### **2. 市场波动**
- 高波动市场：增大 `trailingDistance` 避免被震出
- 低波动市场：减小 `trailingDistance` 紧密跟踪

### **3. 滑点风险**
- 剧烈波动时可能无法成交在预期价格
- 跟踪距离已考虑1.5-2倍ATR的安全边距

### **4. 日志监控**
查看移动止损日志：
```
[移动止损] 盈亏比 0.52 达到激活条件
[移动止损] 止损已更新至 105.50
```

---

## 🎓 使用技巧

### **技巧1：结合TP策略**
- TP1作为第一目标（快速获利）
- 移动止损作为备份保护
- TP2作为最终目标

### **技巧2：根据币种调整**
- **BTC/ETH**：使用默认配置
- **山寨币**：增大激活比例（0.8-1.0）
- **稳定币对**：减小跟踪距离（1.0-1.2）

### **技巧3：不同时段**
- **高波动时段**：增大跟踪距离
- **平静时段**：减小跟踪距离
- **非交易时间**：考虑禁用（已有每日休市）

---

## 📝 常见问题

**Q: 为什么我的止损没有移动？**
- 检查是否启用：`enabled: true`
- 确认是否达到激活盈亏比
- 查看更新间隔是否过长

**Q: 止损移动太频繁怎么办？**
- 增加更新间隔（如120秒）
- 增大跟踪距离

**Q: 如何知道移动止损已触发？**
- 查看日志：`[移动止损]` 相关信息
- 检查持仓的 `lastStopLossUpdate` 字段

**Q: 能否手动触发止损更新？**
- 目前自动运行，每60秒检查一次
- 也可以重启机器人强制检查

---

## 🎉 总结

移动止损功能现已完全集成！

✅ **自动运行** - 无需手动干预
✅ **智能保护** - 只在有利时移动
✅ **可配置** - 适应不同交易风格
✅ **默认启用** - 开箱即用

**建议：** 先使用默认配置观察效果，再根据实际情况调整！
